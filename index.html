<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ARしおり（Multi Targets + Robust Camera Start）</title>

  <!-- A-Frame & MindAR（npm版：aframe用ビルド1本でOK） -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { height:100%; margin:0; background:#000; overflow:hidden; }
    .hint { position:fixed; left:0; right:0; top:0; color:#fff; background:rgba(0,0,0,.35);
            padding:8px 12px; font:600 14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP",Meiryo;
            text-align:center; z-index:3; transition:opacity .3s; }
    .start-btn{ position:fixed; right:12px; bottom:12px; z-index:4; background:#fff; color:#111;
            border:0; border-radius:12px; padding:12px 16px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.35); }
    .toast{ position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:rgba(0,0,0,.7);
            color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; z-index:5; display:none; }
  </style>
</head>
<body>
  <div class="hint" id="hint">「ARを開始」を押してカメラを許可 → 偽しおりの“写真/イラスト”部分を映してください</div>
  <button id="startCam" class="start-btn">ARを開始</button>
  <div class="toast" id="toast"></div>

  <!-- 同階層に targets.mind を必ず置く -->
  <a-scene
    style="width:100vw; height:100vh;"
    mindar-image="imageTargetSrc: ./targets.mind?v=12; autoStart:false; uiScanning:true; uiLoading:true;"
    renderer="alpha:true; antialias:true; physicallyCorrectLights:true; webgl2:false"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    embedded>

    <a-assets timeout="30000">
      <img id="realTrip" src="assets/real-itinerary.jpg" crossorigin="anonymous">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- 複数ターゲット（targets.mind の登録順 0..5 に合わせて増減） -->
    <a-entity mindar-image-target="targetIndex: 0"><a-plane class="overlay" src="#realTrip" position="0 0 0" material="transparent:true; opacity:1.0"></a-plane></a-entity>
    <a-entity mindar-image-target="targetIndex: 1"><a-plane class="overlay" src="#realTrip" position="0 0 0" material="transparent:true; opacity:1.0"></a-plane></a-entity>
    <a-entity mindar-image-target="targetIndex: 2"><a-plane class="overlay" src="#realTrip" position="0 0 0" material="transparent:true; opacity:1.0"></a-plane></a-entity>
    <a-entity mindar-image-target="targetIndex: 3"><a-plane class="overlay" src="#realTrip" position="0 0 0" material="transparent:true; opacity:1.0"></a-plane></a-entity>
    <a-entity mindar-image-target="targetIndex: 4"><a-plane class="overlay" src="#realTrip" position="0 0 0" material="transparent:true; opacity:1.0"></a-plane></a-entity>
    <a-entity mindar-image-target="targetIndex: 5"><a-plane class="overlay" src="#realTrip" position="0 0 0" material="transparent:true; opacity:1.0"></a-plane></a-entity>
  </a-scene>

  <script>
    // 画像比率で全オーバーレイのサイズを同期
    (function(){
      const img = document.getElementById('realTrip');
      const setSize = () => {
        if (img.naturalWidth && img.naturalHeight) {
          const r = img.naturalHeight / img.naturalWidth;
          document.querySelectorAll('.overlay').forEach(p => { p.setAttribute('width', 1); p.setAttribute('height', r); });
        }
      };
      if (img.complete) setSize(); else img.addEventListener('load', setSize);
    })();

    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 4200); }

    // iOS対策：ユーザー操作→scene.loaded待ち→start()。video準備を確認し、だめなら一度だけ自動再起動。
    (function(){
      const btn  = document.getElementById('startCam');
      const hint = document.getElementById('hint');
      const scene = document.querySelector('a-scene');

      let starting = false, started = false, retried = false;

      async function waitSceneLoaded() {
        if (scene.hasLoaded) return;
        await new Promise(r => scene.addEventListener('loaded', r, {once:true}));
      }

      async function ensureTargets() {
        const res = await fetch('./targets.mind?v=12', {method:'HEAD'});
        if (!res.ok) throw new Error('targets.mind が見つかりません（'+res.status+'）');
      }

      function getVideo() {
        // MindARが作るvideo要素。念のため playsinline 等を付与
        const v = document.querySelector('video');
        if (v) { v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); v.muted = true; v.autoplay = true; }
        return v;
      }

      async function waitVideoReady(timeoutMs=2500) {
        const v = getVideo();
        if (!v) return false;
        if (v.readyState >= 2 && v.videoWidth > 0) return true;
        return await new Promise(resolve => {
          let done = false;
          const timer = setTimeout(()=>{ if(!done) { done=true; resolve(false); } }, timeoutMs);
          function ok(){ if(!done){ done=true; clearTimeout(timer); resolve(true);} }
          v.addEventListener('loadedmetadata', ok, {once:true});
          v.addEventListener('canplay', ok, {once:true});
        });
      }

      async function requestHiRes() {
        const v = getVideo();
        const track = v?.srcObject?.getVideoTracks?.()[0];
        if (track?.applyConstraints) {
          try {
            await track.applyConstraints({
              facingMode: { ideal: 'environment' },
              width: { ideal: 1920 }, height: { ideal: 1080 },
              advanced: [{ focusMode: 'continuous' }]
            });
          } catch(_) {}
        }
      }

      async function startAR(force=false){
        if (starting) return;
        if (started && !force) return;
        starting = true;
        try{
          await ensureTargets();              // 1) targets.mind 有無チェック
          await waitSceneLoaded();            // 2) scene 初期化待ち
          const arSystem = scene.systems['mindar-image-system'];

          try { await arSystem.stop(); } catch(_){}
          await arSystem.start();             // 3) カメラ起動

          await requestHiRes();               // 4) 画質リクエスト（未対応は無視）
          const ok = await waitVideoReady();  // 5) videoが本当に映るか確認

          if (!ok && !retried) {              // 6) 真っ黒なら一度だけリトライ
            retried = true;
            try { await arSystem.stop(); } catch(_){}
            await arSystem.start();
            await requestHiRes();
            await waitVideoReady();
          }

          started = true;
          btn.style.display = 'none';
          hint.textContent  = '偽しおりの写真/イラスト部分を映してください';
        }catch(e){
          console.error(e);
          toast('カメラ起動に失敗: ' + (e?.message || e));
        }finally{
          starting = false;
        }
      }

      // ボタンで起動（ユーザー操作扱い）
      btn.addEventListener('click', () => startAR(true));
      // 最初のタップでも起動OK
      const once = () => startAR(true);
      document.addEventListener('pointerdown', once, {once:true});
      document.addEventListener('touchend',   once, {once:true});
      document.addEventListener('click',      once, {once:true});

      // どのターゲットが反応したかログ
      document.querySelectorAll('[mindar-image-target]').forEach((a,i)=>{
        a.addEventListener('targetFound', ()=> console.log('found targetIndex', i));
        a.addEventListener('targetLost',  ()=> console.log('lost  targetIndex', i));
      });
    })();
  </script>
</body>
</html>
