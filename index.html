<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Proposal AR Itinerary (multi-target)</title>
  <!-- A-Frame & MindAR (公式CDN 1.2.5) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background: #000; }
    #hint { position: fixed; left:0; right:0; top:0; color:#fff; background: rgba(0,0,0,.35); padding:10px 12px; font: 600 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans JP"; text-align:center; z-index:3; }
    #start { position: fixed; right: 12px; bottom: 12px; z-index: 4; background:#fff; color:#111; border:none; border-radius:12px; padding:12px 16px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.35); }
    #toast { position: fixed; left:50%; bottom: 16px; transform: translateX(-50%); background: rgba(0,0,0,.7); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; z-index:5; display:none; }
  </style>
</head>
<body>
  <div id="hint">カメラを開始し、偽しおりの“特徴が多い部分”（左の写真コラムなど）を映してください</div>
  <button id="start">ARを開始</button>
  <div id="toast"></div>

  <!-- 期待する構成：
    ./index.html
    ./targets.mind                ← MindARの出力（複数ターゲットをまとめた1ファイル）
    ./assets/real-itinerary.jpg   ← 差し替え画像（.png の場合は下の <img> を .png に変更）
  -->

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind?v=7; autoStart: false; uiLoading: true; uiScanning: true;"
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; alpha: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded>

    <a-assets timeout="30000">
      <!-- ※ .png を使う場合は拡張子を .png に変更 -->
      <img id="real" src="./assets/real-itinerary.jpg" crossorigin="anonymous" />
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- ▼ 複数ターゲット用アンカー。コンパイルした数だけ増減してください（0,1,2,...） -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane class="overlay" src="#real" position="0 0 0" rotation="0 0 0"
               width="1" height="0.6" material="transparent: true; side: double;"></a-plane>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 1">
      <a-plane class="overlay" src="#real" position="0 0 0" rotation="0 0 0"
               width="1" height="0.6" material="transparent: true; side: double;"></a-plane>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2">
      <a-plane class="overlay" src="#real" position="0 0 0" rotation="0 0 0"
               width="1" height="0.6" material="transparent: true; side: double;"></a-plane>
    </a-entity>

    <!-- 必要なら以下を複製して 3,4,... を追加 -->

  </a-scene>

  <script>
    (function(){
      const scene = document.querySelector('a-scene');
      let arSystem = null; // scene loaded後に取得
      const startBtn = document.getElementById('start');
      const toast = document.getElementById('toast');

      function showToast(msg){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=>toast.style.display='none', 4200); }

      // 画像のアスペクト比でオーバーレイの高さを揃える
      const img = document.getElementById('real');
      function applySize(){ if(!img.naturalWidth||!img.naturalHeight) return; const r = img.naturalHeight/img.naturalWidth; document.querySelectorAll('.overlay').forEach(p=>p.setAttribute('height', r)); }
      if (img.complete) applySize(); else img.addEventListener('load', applySize);

      // targets.mind が存在するか簡易チェック
      fetch('./targets.mind?v=7', {method:'HEAD'}).then(res=>{ if(!res.ok) showToast('targets.mind が見つかりません（' + res.status + '）'); }).catch(()=>{});

      // スタート処理（iOSはユーザー操作から）
      async function startAR(){
        try{
          if (!scene.hasLoaded) await new Promise(r=>scene.addEventListener('loaded', r, {once:true}));
          arSystem = scene.systems['mindar-image-system'];
          try{ await arSystem.stop(); }catch(_){}
          await arSystem.start();
          startBtn.style.display = 'none';
        }catch(e){
          console.error(e);
          if(/Permission|NotAllowed/i.test(String(e))) showToast('カメラ許可をONにしてください（aA > Webサイトの設定 > カメラ：許可）');
          else showToast('起動エラー: ' + e);
        }
      }

      startBtn.addEventListener('click', startAR);
      // どれが反応したかログ
      document.querySelectorAll('[mindar-image-target]').forEach((anchor, i)=>{
        anchor.addEventListener('targetFound', ()=> console.log('found targetIndex', i));
        anchor.addEventListener('targetLost',  ()=> console.log('lost  targetIndex', i));
      });

      scene.addEventListener('arReady', ()=>{
        document.getElementById('hint').textContent = '偽しおりの特徴が多い部分を映してください';
      });
    })();
  </script>
</body>
</html>
