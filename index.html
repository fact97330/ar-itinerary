<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>ARしおり（HD強制＋デバッグ10行）</title>

  <!-- ★ MindARより先に：getUserMedia を上書きして初回からHDを要求 -->
  <script>
    (function () {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
      const origGUM = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
      navigator.mediaDevices.getUserMedia = function (constraints = {}) {
        // MindAR/A-Frame が {video:true} 等で呼んでも、ここでHD要求に差し替える
        if (constraints.video) {
          constraints = {
            audio: false,
            video: {
              facingMode: { ideal: 'environment' },          // 背面
              width:  { min: 1280, ideal: 1920 },            // 1080p狙い（最低720p）
              height: { min:  720, ideal: 1080 },
              aspectRatio: { ideal: 1.7777777778 },          // 16:9
              frameRate: { ideal: 30, max: 60 },
              resizeMode: 'crop-and-scale',
              advanced: [{ focusMode: 'continuous' }]
            }
          };
        }
        return origGUM(constraints);
      };
    })();
  </script>

  <!-- A-Frame & MindAR（この順） -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; }
    .hint { position:fixed; left:0; right:0; top:0; z-index:3; color:#fff; background:rgba(0,0,0,.35);
            padding:8px 12px; font:14px/1.4 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',Meiryo; text-align:center; }
    .start-btn{ position:fixed; right:12px; bottom:12px; z-index:4; background:#fff; color:#111; border:0; border-radius:12px;
                padding:12px 16px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.35); }
    .panel{ position:fixed; left:8px; bottom:8px; z-index:2147483647; pointer-events:none; background:rgba(0,0,0,.7); color:#00ff88;
            font:13px/1.5 ui-monospace,Menlo,Consolas,monospace; padding:8px 10px; border-radius:10px; max-width:90vw; white-space:pre-wrap; box-shadow:0 8px 24px rgba(0,0,0,.5); }
  </style>
</head>
<body>
  <div class="hint" id="hint">「カメラ開始」を押す → ターゲットを画面の7〜8割で真正面から</div>
  <button id="startCam" class="start-btn">カメラ開始</button>
  <div id="panel" class="panel">BUILD v17</div>

  <a-scene
    mindar-image="imageTargetSrc: #mindfile; autoStart:false; uiScanning:true; uiLoading:true;"
    renderer="alpha:true; antialias:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    embedded>

    <a-assets timeout="30000">
      <!-- ★ キャッシュ回避 -->
      <a-asset-item id="mindfile" src="targets.mind?v=17"></a-asset-item>
      <img id="realTrip" src="assets/real-itinerary.png?v=17"
           onerror="this.onerror=null; this.src='assets/real-itinerary.jpg?v=17'">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- 単一ターゲット（index 0）。flat で確実に明るく表示 -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-image id="overlay" src="#realTrip" visible="false"
               position="0 0 0.01"
               material="shader: flat; transparent: true; opacity: 1; side: double"></a-image>
    </a-entity>
  </a-scene>

  <script>
    // ===== 画面ログ（最後の10行だけ保持） =====
    const panel = document.getElementById('panel'), ring=[];
    const log = (s)=>{ ring.push(s); if(ring.length>10) ring.splice(0, ring.length-10); panel.textContent='BUILD v17\n'+ring.join('\n'); };
    window.addEventListener('error', e=>log('[window.error] '+e.message));
    window.addEventListener('unhandledrejection', e=>log('[promise] '+(e.reason?.message||e.reason)));

    // ===== 画像サイズ 1:ratio =====
    (function(){
      const img=document.getElementById('realTrip'), overlay=document.getElementById('overlay');
      function setSize(){ if(img.naturalWidth&&img.naturalHeight){ const r=img.naturalHeight/img.naturalWidth; overlay.setAttribute('width',1); overlay.setAttribute('height',r); log('[overlay] size h='+r.toFixed(3)); } }
      if(img.complete) setSize(); else img.addEventListener('load', setSize);
    })();

    (function(){
      const btn=document.getElementById('startCam'), hint=document.getElementById('hint');
      const scene=document.querySelector('a-scene'), assets=document.querySelector('a-assets'), mindfile=document.getElementById('mindfile');
      const overlay=document.getElementById('overlay'), anchor=document.querySelector('[mindar-image-target]');
      let starting=false, started=false;

      assets.addEventListener('loaded', ()=>log('[assets] loaded'));
      mindfile.addEventListener('loaded', ()=>log('[assets] mindfile loaded'));
      mindfile.addEventListener('error',  ()=>log('[assets] mindfile ERROR'));

      scene.addEventListener('loaded',  ()=>log('[scene] loaded'));
      scene.addEventListener('arReady', ()=>log('[mindar] ready'));
      scene.addEventListener('arError', e=>log('[mindar] error '+(e.detail?.error||'')));

      // 実デバイスを見て“背面”IDを特定
      async function pickBackCameraId(){
        try{
          const list = await navigator.mediaDevices.enumerateDevices();
          // label は許可後にしか出ない。'back' 'rear' 'environment' を優先
          const cams = list.filter(d=>d.kind==='videoinput');
          let back = cams.find(d=>/back|rear|environment|背面/i.test(d.label)) || cams.find(d=>/wide/i.test(d.label));
          return back?.deviceId || cams[0]?.deviceId || null;
        }catch(_){ return null; }
      }

      // より強い制約で順に再取得 → 成功したら video.srcObject を差し替え
      async function upgradeStream(){
        const v = document.querySelector('video'); if(!v) return;
        const oldStream = v.srcObject;
        const backId = await pickBackCameraId();
        const candidates = [
          { width:{exact:1920}, height:{exact:1080} },
          { width:{min:1920, ideal:1920}, height:{min:1080, ideal:1080} },
          { width:{exact:1280}, height:{exact:720} },
          { width:{min:1280, ideal:1280}, height:{min:720, ideal:720} }
        ];
        for (const wh of candidates){
          try{
            const stream = await navigator.mediaDevices.getUserMedia({
              audio:false,
              video: {
                ...(backId ? {deviceId:{exact:backId}} : {facingMode:{ideal:'environment'}}),
                ...wh,
                aspectRatio:{ideal:1.7777777778},
                frameRate:{ideal:30, max:60},
                resizeMode:'crop-and-scale',
                advanced:[{focusMode:'continuous'}]
              }
            });
            // 差し替え
            v.srcObject = stream;
            await v.play().catch(()=>{});
            // 旧トラック停止
            oldStream?.getTracks?.().forEach(t=>t.stop());
            // 状態ログ
            const track = stream.getVideoTracks()[0];
            const s = track.getSettings?.()||{};
            log('[upgrade] '+(s.facingMode||'?')+' '+(s.width||'?')+'x'+(s.height||'?')+' fps='+(s.frameRate||'?'));
            setTimeout(()=> log('[video] '+v.videoWidth+'x'+v.videoHeight), 600);
            return true;
          }catch(e){
            log('[upgrade fail] '+(wh.width.exact||wh.width.min)+'x'+(wh.height.exact||wh.height.min)+' '+(e.name||e.message||e));
          }
        }
        return false;
      }

      async function startCamera(force=false){
        if(starting || (started && !force)) return;
        starting=true;
        try{
          log('[start] try');
          try{ await scene.systems['mindar-image-system'].stop(); }catch(_){}
          await scene.systems['mindar-image-system'].start(); // ここで上書きGUMが効く
          started=true;
          btn.style.display='none'; hint.textContent='ターゲットを映してください（画面の7〜8割）';

          // 実際の設定と表示解像度
          const v=document.querySelector('video');
          if (v) {
            await v.play().catch(()=>{});
            const track=v.srcObject?.getVideoTracks?.()[0];
            const s=track?.getSettings?.()||{};
            log('[track] '+(s.facingMode||'?')+' '+(s.width||'?')+'x'+(s.height||'?')+' fps='+(s.frameRate||'?'));
            setTimeout(()=> log('[video] '+v.videoWidth+'x'+v.videoHeight), 600);
          }

          // 低解像度なら強制アップグレードを試みる
          setTimeout(async ()=>{
            const vw = v?.videoWidth||0, vh = v?.videoHeight||0;
            if (Math.max(vw, vh) < 1000) { // 例：480x640等
              log('[upgrade] try higher resolution…');
              await upgradeStream();
            }
          }, 800);

          log('[start] done');
        }catch(e){
          log('[start error] '+(e?.message||e));
          alert('カメラ起動に失敗: '+(e?.message||e));
        }finally{ starting=false; }
      }

      btn.addEventListener('click', ()=>startCamera(true));
      const once=()=>startCamera(true);
      document.addEventListener('pointerdown', once, {once:true});
      document.addEventListener('touchend',   once, {once:true});
      document.addEventListener('click',      once, {once:true});

      anchor.addEventListener('targetFound', ()=>{
        overlay.setAttribute('visible',true);
        log('[track] found targetIndex 0');
      });
      anchor.addEventListener('targetLost', ()=>{
        overlay.setAttribute('visible',false);
        log('[track] lost targetIndex 0');
      });

      // 回転/復帰時の再スタート（自動リロードは一切なし）
      window.addEventListener('orientationchange', ()=> setTimeout(()=> startCamera(true), 350));
      document.addEventListener('visibilitychange', ()=> { if(document.visibilityState==='visible') setTimeout(()=> startCamera(true), 100); });
      window.addEventListener('pageshow', (e)=> { if(e.persisted) setTimeout(()=> startCamera(true), 100); });
    })();
  </script>
</body>
</html>
