<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ARしおり（PNG置換・縮小付き・デバッグ10行）</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; }
    .hint { position:fixed; left:0; right:0; top:0; z-index:3; color:#fff; background:rgba(0,0,0,.35);
      padding:8px 12px; font:14px/1.4 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',Meiryo; }
    .start-btn{ position:fixed; right:12px; bottom:12px; z-index:4; background:#fff; color:#111; border:0; border-radius:12px;
      padding:12px 16px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.35); }
    .panel{ position:fixed; left:8px; bottom:8px; z-index:2147483647; pointer-events:none;
      background:rgba(0,0,0,.7); color:#00ff88; font:13px/1.5 ui-monospace,Menlo,Consolas,monospace;
      padding:8px 10px; border-radius:10px; max-width:90vw; white-space:pre-wrap; box-shadow:0 8px 24px rgba(0,0,0,.5) }
  </style>
</head>
<body>
  <div class="hint" id="hint">「カメラ開始」を押し、ターゲットを画面の7〜8割で真正面から映してください</div>
  <button id="startCam" class="start-btn">カメラ開始</button>
  <div id="panel" class="panel">BUILD v20</div>

  <a-scene
    mindar-image="imageTargetSrc: targets.mind?v=20; autoStart:false; uiScanning:true; uiLoading:true; maxTrack:1"
    renderer="alpha:true; antialias:true; physicallyCorrectLights:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    embedded>

    <a-assets timeout="30000">
      <!-- プレースホルダ（JSで実体を差し替える） -->
      <img id="realTrip" src="" crossorigin="anonymous">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- 明るく表示できる a-image + flat、少し手前へ -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-image id="overlay" src="#realTrip" visible="false"
               position="0 0 0.02"
               material="shader: flat; transparent: true; opacity: 1; side: double">
      </a-image>
    </a-entity>
  </a-scene>

  <script>
    // ===== 画面ログ（最後10行のみ） =====
    const panel = document.getElementById('panel');
    const ring = [];
    const log = (m)=>{ ring.push(m); if(ring.length>10) ring.splice(0, ring.length-10); panel.textContent='BUILD v20\n'+ring.join('\n'); };
    window.addEventListener('error', e=>log('[window.error] '+e.message));
    window.addEventListener('unhandledrejection', e=>log('[promise] '+(e.reason?.message||e.reason)));

    // ===== 画像ローダ：候補を順に試し、必要なら 2048px に縮小して適用 =====
    async function loadBestImage() {
      const VERSION = 'v=20';
      const candidates = [
        `assets/real-itinerary.png?${VERSION}`,
        `assets/real-itinerary.jpg?${VERSION}`,
        `assets/slide7.png?${VERSION}`,
        `assets/%E3%82%B9%E3%83%A9%E3%82%A4%E3%83%897.png?${VERSION}` // 「スライド7.png」
      ];
      for (const url of candidates) {
        try {
          const blob = await fetch(url, {cache:'no-store'}).then(r => { if(!r.ok) throw new Error(r.status); return r.blob(); });
          const dataUrl = await blobToScaledDataURL(blob, 2048); // 長辺 2048 に縮小
          const img = document.getElementById('realTrip');
          img.crossOrigin = 'anonymous';
          img.src = dataUrl;
          await img.decode();
          log('[image] loaded '+ url.split('?')[0] +' → tex '+img.naturalWidth+'x'+img.naturalHeight);
          return true;
        } catch(e) {
          log('[image] skip '+url.split('?')[0]+' ('+(e.message||e)+')');
        }
      }
      log('[image] no candidate loaded');
      return false;
    }
    function blobToScaledDataURL(blob, max) {
      return new Promise((resolve,reject)=>{
        const img = new Image(); img.crossOrigin='anonymous';
        img.onload = ()=>{
          let {width:w, height:h} = img;
          const s = Math.max(w,h);
          if (s > max) { const k = max / s; w = Math.round(w*k); h = Math.round(h*k); }
          const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL('image/png', 0.92));
        };
        img.onerror = ()=>reject(new Error('img load fail'));
        img.src = URL.createObjectURL(blob);
      });
    }

    // ===== 画像比率に合わせて a-image の幅:高を 1:ratio に =====
    function sizeOverlayByImage(){
      const img = document.getElementById('realTrip');
      const overlay = document.getElementById('overlay');
      if (img.naturalWidth && img.naturalHeight) {
        const ratio = img.naturalHeight / img.naturalWidth;
        overlay.setAttribute('width', 1);
        overlay.setAttribute('height', ratio);
        log('[overlay] size set h=' + ratio.toFixed(3));
      }
    }

    // ===== targets.mind の存在チェック =====
    (async()=>{ try{
      const r=await fetch('targets.mind?v=20',{method:'HEAD'}); log('[targets HEAD] '+r.status+' '+(r.ok?'OK':'NG'));
      if(!r.ok) alert('targets.mind が見つかりません');
    }catch(e){ log('[targets HEAD error] '+e.message); }})();

    // ===== 起動・検出 =====
    (function(){
      const btn=document.getElementById('startCam'), hint=document.getElementById('hint'), scene=document.querySelector('a-scene');
      scene.addEventListener('loaded',  ()=>log('[scene] loaded'));
      scene.addEventListener('arReady', ()=>log('[mindar] ready'));
      scene.addEventListener('arError', e=>log('[mindar] error '+(e.detail?.error||'')));

      let starting=false, started=false;

      async function bumpCameraQuality(){
        const v=document.querySelector('video'); if(!v) return;
        try{
          v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); v.muted=true; await v.play().catch(()=>{});
          const track=v.srcObject?.getVideoTracks?.()[0];
          if(track?.applyConstraints){
            await track.applyConstraints({
              facingMode:{ideal:'environment'},
              width:{ideal:1920}, height:{ideal:1080},
              advanced:[{focusMode:'continuous'}]
            });
          }
          await v.play().catch(()=>{});
          setTimeout(()=>log('[video] '+v.videoWidth+'x'+v.videoHeight),600);
        }catch(e){ log('[bumpCameraQuality] '+(e.message||e)); }
      }

      async function startCamera(force=false){
        if(starting || (started && !force)) return;
        starting=true;
        try{
          // 画像の用意（ダウンスケール込み）
          await loadBestImage();
          sizeOverlayByImage();

          log('[start] try');
          try{ await scene.systems['mindar-image-system'].stop(); }catch(_){}
          await scene.systems['mindar-image-system'].start();
          await bumpCameraQuality();
          started=true; btn.style.display='none'; hint.textContent='ターゲットを映してください（画面の7〜8割）';
          log('[start] done');
        }catch(e){ log('[start error] '+(e?.message||e)); alert('カメラ起動に失敗: '+(e?.message||e)); }
        finally{ starting=false; }
      }

      btn.addEventListener('click', ()=>startCamera(true));
      const once=()=>startCamera(true);
      document.addEventListener('pointerdown',once,{once:true});
      document.addEventListener('touchend',once,{once:true});
      document.addEventListener('click',once,{once:true});

      // 検出時：PNG表示／見失い時：非表示
      const anchor=document.querySelector('[mindar-image-target]');
      const overlay=document.getElementById('overlay');

      anchor.addEventListener('targetFound', ()=>{
        overlay.setAttribute('visible', true);
        // 念のため再バインド・材質再設定（ロード順レース対策）
        overlay.setAttribute('src', '#realTrip');
        overlay.setAttribute('material', 'shader: flat; transparent: true; opacity: 1; side: double');
        log('[track] found targetIndex 0');
      });
      anchor.addEventListener('targetLost',  ()=>{
        overlay.setAttribute('visible', false);
        log('[track] lost  targetIndex 0');
      });

      // 端末回転/復帰で再スタート
      window.addEventListener('orientationchange', ()=>setTimeout(()=>startCamera(true),350));
      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') setTimeout(()=>startCamera(true),100); });
      window.addEventListener('pageshow', e=>{ if(e.persisted) setTimeout(()=>startCamera(true),100); });
    })();
  </script>
</body>
</html>
