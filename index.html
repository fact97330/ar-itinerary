<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ARしおり（確実表示デバッグ版）</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;background:#000;overflow:hidden}
  .hint{position:fixed;left:0;right:0;top:0;z-index:3;color:#fff;background:rgba(0,0,0,.35);padding:8px 12px;font:14px/1.4 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',Meiryo}
  .start-btn{position:fixed;right:12px;bottom:12px;z-index:4;background:#fff;color:#111;border:0;border-radius:12px;padding:12px 16px;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .panel{position:fixed;left:8px;bottom:8px;z-index:99999;background:rgba(0,0,0,.7);color:#0f8;white-space:pre-wrap;padding:8px 10px;border-radius:10px;font:13px/1.5 ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
  <div class="hint" id="hint">「カメラ開始」を押し、ターゲットを画面の7〜8割で真正面から映してください</div>
  <button id="startCam" class="start-btn">カメラ開始</button>
  <div id="panel" class="panel">BUILD v21</div>

  <a-scene mindar-image="imageTargetSrc: targets.mind?v=21; autoStart:false; uiScanning:true; uiLoading:true"
           renderer="alpha:true; antialias:true"
           vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false" embedded>
    <a-assets timeout="30000">
      <!-- ★ ASCII 名に統一した差し替え画像 -->
      <img id="overlayImg" src="assets/real-itinerary.png?v=24" crossorigin="anonymous">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <!-- 緊急時の可視化用：緑の板（画像が読めなくても見える） -->
      <a-plane id="debugPlane" color="#00ff88" opacity="0.3" visible="false" position="0 0 0.005"></a-plane>
      <!-- 本命：画像。flat で明るく、両面、少し手前 -->
      <a-image id="overlay" src="#overlayImg" visible="false"
               position="0 0 0.01"
               material="shader:flat; transparent:true; opacity:1; side:double"></a-image>
    </a-entity>
  </a-scene>

<script>
  const panel=document.getElementById('panel'), log=(m)=>{ panel.textContent += '\n'+m; };

  // 画像ロード状況を必ず記録
  (function(){
    const img=document.getElementById('overlayImg');
    img.addEventListener('load', ()=> log('[image] loaded '+img.naturalWidth+'x'+img.naturalHeight));
    img.addEventListener('error',()=> log('[image] ERROR (path or name?)'));
  })();

  // 幅1・高さ=比率に合わせる
  (function(){
    const img=document.getElementById('overlayImg'), overlay=document.getElementById('overlay'), dbg=document.getElementById('debugPlane');
    function fit(){
      if (!img.naturalWidth || !img.naturalHeight) return;
      const r=img.naturalHeight/img.naturalWidth;
      overlay.setAttribute('width',1); overlay.setAttribute('height',r);
      dbg.setAttribute('width',1); dbg.setAttribute('height',r);
      log('[overlay] size set h='+r.toFixed(3));
    }
    if (img.complete) fit(); else img.addEventListener('load', fit);
  })();

  // targets.mind の有無
  fetch('targets.mind?v=21',{method:'HEAD'}).then(r=>log('[targets HEAD] '+r.status+' '+(r.ok?'OK':'NG')))
                                             .catch(e=>log('[targets HEAD error] '+e.message));

  (function(){
    const btn=document.getElementById('startCam'), hint=document.getElementById('hint'), scene=document.querySelector('a-scene');
    scene.addEventListener('loaded', ()=>log('[scene] loaded'));
    scene.addEventListener('arReady', ()=>log('[mindar] ready'));
    scene.addEventListener('arError', e=>log('[mindar] error '+(e.detail?.error||'')));
    let starting=false, started=false;

    async function startCamera(force=false){
      if(starting || (started && !force)) return;
      starting=true;
      try{
        log('[start] try');
        try{ await scene.systems['mindar-image-system'].stop(); }catch(_){}
        await scene.systems['mindar-image-system'].start();
        started=true; btn.style.display='none'; hint.textContent='ターゲットを映してください（画面の7〜8割）';
        const v=document.querySelector('video'); setTimeout(()=>{ if(v) log('[video] '+v.videoWidth+'x'+v.videoHeight); },600);
        log('[start] done');
      }catch(e){ log('[start error] '+(e?.message||e)); alert('カメラ起動に失敗: '+(e?.message||e)); }
      finally{ starting=false; }
    }
    btn.addEventListener('click', ()=>startCamera(true));
    const once=()=>startCamera(true); document.addEventListener('pointerdown',once,{once:true}); document.addEventListener('touchend',once,{once:true}); document.addEventListener('click',once,{once:true});

    const anchor=document.querySelector('[mindar-image-target]');
    const overlay=document.getElementById('overlay'), dbg=document.getElementById('debugPlane');
    anchor.addEventListener('targetFound', ()=>{
      log('[track] found targetIndex 0');
      // 画像が無ければ緑の板だけでも出す
      const ok = document.getElementById('overlayImg').naturalWidth > 0;
      dbg.setAttribute('visible', true);
      overlay.setAttribute('visible', ok);
    });
    anchor.addEventListener('targetLost', ()=>{
      log('[track] lost  targetIndex 0');
      overlay.setAttribute('visible', false);
      dbg.setAttribute('visible', false);
    });
  })();
</script>
</body>
</html>
