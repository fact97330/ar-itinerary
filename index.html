<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ARしおり（MindAR 本番）</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; }
    .hint{position:fixed; left:0; right:0; top:0; z-index:3; color:#fff;
      background:rgba(0,0,0,.35); padding:8px 12px;
      font:14px/1.4 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Noto Sans JP',Meiryo;}
    .start-btn{position:fixed; right:12px; bottom:12px; z-index:4; background:#fff; color:#111;
      border:0; border-radius:12px; padding:12px 16px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,.35);}
  </style>
</head>
<body>
  <div class="hint" id="hint">「カメラ開始」を押してターゲットを画面の7〜8割入る距離で映してください</div>
  <button id="startCam" class="start-btn">カメラ開始</button>

  <!-- targets.mind は index.html と同階層。更新したら ?v=10 の数字を上げる -->
  <a-scene
    mindar-image="imageTargetSrc: targets.mind?v=10; autoStart:false; uiScanning:true; uiLoading:true; maxTrack:1; warmupTolerance:2; missTolerance:5; filterMinCF:0.001; filterBeta:0.001"
    renderer="alpha:true; antialias:true; physicallyCorrectLights:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    embedded>

    <a-assets timeout="30000">
      <!-- 置き換え先（本物のしおり） -->
      <img id="realTrip" src="assets/real-itinerary.jpg">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- 単一ターゲット（targets.mind の最初の画像＝ index 0） -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane id="overlay" src="#realTrip"
               position="0 0 0" rotation="0 0 0"
               material="transparent:true; opacity:1.0"></a-plane>
    </a-entity>
  </a-scene>

  <script>
    // 画像比率で平面サイズを合わせる（ターゲット幅=1に対して等倍）
    (function(){
      const img=document.getElementById('realTrip'), plane=document.getElementById('overlay');
      function setSize(){ if(img.naturalWidth&&img.naturalHeight){ const r=img.naturalHeight/img.naturalWidth; plane.setAttribute('width',1); plane.setAttribute('height',r); } }
      if(img.complete) setSize(); else img.addEventListener('load', setSize);
    })();

    // iOS対策：手動起動＋高画質リクエスト（連続AF・FHD・背面カメラ）
    (function(){
      const btn=document.getElementById('startCam'), hint=document.getElementById('hint');
      const scene=document.querySelector('a-scene'); let starting=false, started=false;

      async function bumpCameraQuality(){
        const v=document.querySelector('video'); if(!v) return;
        try{
          v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); v.muted=true; await v.play().catch(()=>{});
          const track=v.srcObject?.getVideoTracks?.()[0];
          if(track?.applyConstraints){
            await track.applyConstraints({
              facingMode:{ideal:'environment'},
              width:{ideal:1920}, height:{ideal:1080},
              advanced:[{focusMode:'continuous'}]
            });
          }
          await v.play().catch(()=>{});
        }catch(_){}
      }

      async function startCamera(force=false){
        if(starting || (started && !force)) return; starting=true;
        try{
          try{ await scene.systems['mindar-image-system'].stop(); }catch(_){}
          await scene.systems['mindar-image-system'].start();
          await bumpCameraQuality();
          started=true; btn.style.display='none'; hint.textContent='ターゲットを映してください（画面の7〜8割）';
        }catch(e){ alert('カメラ起動に失敗: '+(e?.message||e)); }
        finally{ starting=false; }
      }

      btn.addEventListener('click', ()=>startCamera(true));
      const once=()=>startCamera(true);
      document.addEventListener('pointerdown',once,{once:true});
      document.addEventListener('touchend',once,{once:true});
      document.addEventListener('click',once,{once:true});

      // 見つかったらヒント非表示
      const anchor=document.querySelector('[mindar-image-target]');
      anchor.addEventListener('targetFound', ()=>{ hint.style.opacity='0'; setTimeout(()=>hint.style.display='none',400); });
      anchor.addEventListener('targetLost',  ()=>{ hint.style.display='block'; hint.style.opacity='1'; });

      // 回転/復帰時に再スタート
      window.addEventListener('orientationchange', ()=>setTimeout(()=>startCamera(true),350));
      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') setTimeout(()=>startCamera(true),100); });
      window.addEventListener('pageshow', e=>{ if(e.persisted) setTimeout(()=>startCamera(true),100); });
    })();
  </script>
</body>
</html>
