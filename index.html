<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Proposal AR Itinerary</title>
  <!-- A-Frame & MindAR (pinned versions that work well on iOS Safari) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background: #000; }
    /* 画面上の簡単なヘルプ */
    #ui { position: fixed; left: 0; right: 0; top: 0; padding: 12px env(safe-area-inset-right) 12px env(safe-area-inset-left);
          display: flex; gap: 8px; align-items: center; justify-content: center; z-index: 3; pointer-events: none; }
    #hint { background: rgba(0,0,0,.55); color: #fff; font: 600 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 10px 12px; border-radius: 10px; pointer-events: auto; }
    #hint button { margin-left: 8px; }
    .hidden { display: none; }
    /* スタート画面（iOSでのユーザー操作トリガー用） */
    #start { position: fixed; inset: 0; display: grid; place-items: center; background: #000; z-index: 4; }
    #start .box { text-align: center; color: #fff; font: 600 16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    #start button { padding: 14px 22px; font: inherit; border-radius: 12px; border: 0; }
    #err { margin-top: 10px; color: #ffb4b4; font-weight: 600; }
  </style>
</head>
<body>
  <!-- 画面上の説明（任意） -->
  <div id="ui">
    <div id="hint">
      カメラ使用を「許可」→ 偽のしおりにかざしてください。合致すると本物のしおりが上に表示されます。
      <button onclick="document.getElementById('hint').classList.add('hidden')">OK</button>
    </div>
  </div>

  <!--
    期待する配置：
      ./index.html
      ./targets.mind              ← MindARで作成したターゲット（偽しおりの画像から生成）
      ./assets/real-itinerary.png ← 差し替えたい本物のしおり画像
  -->

  <!-- スタート画面（ユーザーの明示タップでカメラ起動を確実にする） -->
  <div id="start">
    <div class="box">
      <div style="opacity:.85;margin-bottom:16px">「ARを開始」を押してカメラを許可してください</div>
      <button id="startBtn">ARを開始</button>
      <div id="err" class="hidden"></div>
    </div>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: true; uiScanning: true;"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    color-management
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
  >
    <a-assets>
      <!-- 差し替え表示する本物のしおり -->
      <img id="real" src="./assets/real-itinerary.png" crossorigin="anonymous" />
    </a-assets>

    <!-- iOS Safariではlook-controlsは不要。AR空間固定のカメラを使う -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- ターゲットが見つかった場所に、同じサイズ感で画像を重ねる -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!--
        width=1 は「ターゲット画像の実寸幅と同じ」を意味します。
        height は下のスクリプトで画像の縦横比に合わせて自動設定します。
      -->
      <a-plane id="overlay" src="#real" position="0 0 0" rotation="0 0 0"
               width="1" height="0.6" material="transparent: true; side: double;"></a-plane>
    </a-entity>
  </a-scene>

  <script>
    // 読み込んだ画像の縦横比に合わせて、プレーンの高さを自動調整
    (function () {
      const img = document.getElementById('real');
      const plane = document.getElementById('overlay');
      function applySize() {
        if (!img.naturalWidth || !img.naturalHeight) return;
        const ratio = img.naturalHeight / img.naturalWidth; // 高さ / 幅
        plane.setAttribute('height', ratio); // width=1 に対する高さ
      }
      if (img.complete) applySize(); else img.addEventListener('load', applySize);

      const sceneEl = document.querySelector('a-scene');
      let arSystem = null; // scene loaded 後に取得
      const startUI = document.getElementById('start');
      const startBtn = document.getElementById('startBtn');
      const errBox = document.getElementById('err');

      function showErr(msg){ errBox.textContent = msg; errBox.classList.remove('hidden'); }

      // 1) 非HTTPSだとカメラは動きません
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        showErr('このページはHTTPSで開いてください（GitHub Pages を有効化）');
      }

      // 2) iOSではユーザー操作から start() を呼ぶのが確実
      startBtn.addEventListener('click', async () => {
        errBox.classList.add('hidden');
        try {
          await arSystem.start(); // ここでカメラ起動 & 権限ダイアログ
          startUI.classList.add('hidden');
          document.getElementById('hint')?.classList.add('hidden');
        } catch (e) {
          // 典型的な失敗パターンのメッセージ
          if (/NotAllowedError|Permission/i.test(String(e))) {
            showErr('カメラの権限が拒否されています。アドレスバー左の「aA」→ Webサイトの設定 → カメラ：許可 に変更してください。');
          } else if (/NotFoundError|DevicesNotFoundError/i.test(String(e))) {
            showErr('カメラが見つかりません。別のブラウザタブで使用中でないか確認してください。');
          } else {
            showErr('カメラ起動に失敗：' + e);
          }
        }
      });

      // 検出/ロスト時にヘルプの表示切替（任意）
      const anchor = document.querySelector('[mindar-image-target]');
      anchor.addEventListener('targetFound', () => {
        document.getElementById('hint')?.classList.add('hidden');
      });

      // MindAR からのエラーイベント
      sceneEl.addEventListener('arError', (e) => {
        showErr('AR初期化エラー: ' + (e?.detail?.message || 'unknown'));
      });
    })();
  </script>
</body>
</html>
